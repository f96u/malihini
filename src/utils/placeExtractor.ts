import { Location } from '@/atoms';
import { searchPlaces } from './places';

// Botの応答テキストから場所の情報を抽出して検索
export async function extractPlacesFromBotResponse(text: string): Promise<Location[]> {
  const locations: Location[] = [];
  
  // TODO: もっと良い方法を考える
  // 一般的な場所のパターンを検出
  const placePatterns = [
    // 地名 + 駅
    /([^\s]+駅)/g,
    // 地名 + タワー
    /([^\s]+タワー)/g,
    // 地名 + 公園
    /([^\s]+公園)/g,
    // 地名 + 寺
    /([^\s]+寺)/g,
    // 地名 + 神社
    /([^\s]+神社)/g,
    // 地名 + 城
    /([^\s]+城)/g,
    // 地名 + 美術館
    /([^\s]+美術館)/g,
    // 地名 + 博物館
    /([^\s]+博物館)/g,
    // 地名 + 水族館
    /([^\s]+水族館)/g,
    // 地名 + 動物園
    /([^\s]+動物園)/g,
    // 地名 + 空港
    /([^\s]+空港)/g,
    // 地名 + 港
    /([^\s]+港)/g,
    // 地名 + 大学
    /([^\s]+大学)/g,
    // 地名 + 病院
    /([^\s]+病院)/g,
    // 地名 + デパート
    /([^\s]+デパート)/g,
    // 地名 + ショッピングセンター
    /([^\s]+ショッピングセンター)/g,
    // 地名 + モール
    /([^\s]+モール)/g,
    // 地名 + ビル
    /([^\s]+ビル)/g,
    // 地名 + ホテル
    /([^\s]+ホテル)/g,
    // 地名 + レストラン
    /([^\s]+レストラン)/g,
    // 地名 + カフェ
    /([^\s]+カフェ)/g,
    // 地名 + バー
    /([^\s]+バー)/g,
    // 地名 + 居酒屋
    /([^\s]+居酒屋)/g,
    // 地名 + ラーメン
    /([^\s]+ラーメン)/g,
    // 地名 + 寿司
    /([^\s]+寿司)/g,
    // 地名 + 焼肉
    /([^\s]+焼肉)/g,
    // 地名 + 温泉
    /([^\s]+温泉)/g,
    // 地名 + スキー場
    /([^\s]+スキー場)/g,
    // 地名 + ゴルフ場
    /([^\s]+ゴルフ場)/g,
    // 地名 + テーマパーク
    /([^\s]+テーマパーク)/g,
    // 地名 + 遊園地
    /([^\s]+遊園地)/g,
    // 地名 + 映画館
    /([^\s]+映画館)/g,
    // 地名 + 劇場
    /([^\s]+劇場)/g,
    // 地名 + スタジアム
    /([^\s]+スタジアム)/g,
    // 地名 + アリーナ
    /([^\s]+アリーナ)/g,
    // 地名 + ドーム
    /([^\s]+ドーム)/g,
    // 地名 + センター
    /([^\s]+センター)/g,
    // 地名 + プラザ
    /([^\s]+プラザ)/g,
    // 地名 + スクエア
    /([^\s]+スクエア)/g,
    // 地名 + ストリート
    /([^\s]+ストリート)/g,
    // 地名 + 通り
    /([^\s]+通り)/g,
    // 地名 + 橋
    /([^\s]+橋)/g,
    // 地名 + 川
    /([^\s]+川)/g,
    // 地名 + 山
    /([^\s]+山)/g,
    // 地名 + 湖
    /([^\s]+湖)/g,
    // 地名 + 海
    /([^\s]+海)/g,
    // 地名 + 島
    /([^\s]+島)/g,
    // 地名 + 岬
    /([^\s]+岬)/g,
    // 地名 + 湾
    /([^\s]+湾)/g,
    // 地名 + 半島
    /([^\s]+半島)/g,
    // 地名 + 高原
    /([^\s]+高原)/g,
    // 地名 + 渓谷
    /([^\s]+渓谷)/g,
    // 地名 + 滝
    /([^\s]+滝)/g,
    // 地名 + 洞窟
    /([^\s]+洞窟)/g,
    // 地名 + 遺跡
    /([^\s]+遺跡)/g,
    // 地名 + 城跡
    /([^\s]+城跡)/g,
    // 地名 + 古墳
    /([^\s]+古墳)/g,
    // 地名 + 神社
    /([^\s]+神社)/g,
    // 地名 + 寺院
    /([^\s]+寺院)/g,
    // 地名 + 教会
    /([^\s]+教会)/g,
    // 地名 + モスク
    /([^\s]+モスク)/g,
    // 地名 + 寺院
    /([^\s]+寺院)/g,
    // 地名 + 仏閣
    /([^\s]+仏閣)/g,
    // 地名 + 神社
    /([^\s]+神社)/g,
    // 地名 + 神宮
    /([^\s]+神宮)/g,
    // 地名 + 大社
    /([^\s]+大社)/g,
    // 地名 + 宮
    /([^\s]+宮)/g,
    // 地名 + 閣
    /([^\s]+閣)/g,
    // 地名 + 堂
    /([^\s]+堂)/g,
    // 地名 + 院
    /([^\s]+院)/g,
    // 地名 + 庵
    /([^\s]+庵)/g,
    // 地名 + 坊
    /([^\s]+坊)/g,
    // 地名 + 寺
    /([^\s]+寺)/g,
    // 地名 + 神社
    /([^\s]+神社)/g,
    // 地名 + 神宮
    /([^\s]+神宮)/g,
    // 地名 + 大社
    /([^\s]+大社)/g,
    // 地名 + 宮
    /([^\s]+宮)/g,
    // 地名 + 閣
    /([^\s]+閣)/g,
    // 地名 + 堂
    /([^\s]+堂)/g,
    // 地名 + 院
    /([^\s]+院)/g,
    // 地名 + 庵
    /([^\s]+庵)/g,
    // 地名 + 坊
    /([^\s]+坊)/g,
  ];

  const foundPlaces = new Set<string>();

  // 各パターンで場所を検索
  for (const pattern of placePatterns) {
    const matches = text.match(pattern);
    if (matches) {
      matches.forEach(match => {
        if (match.length > 2) { // 短すぎる文字列は除外
          foundPlaces.add(match);
        }
      });
    }
  }

  // 見つかった場所をPlaces APIで検索
  for (const place of foundPlaces) {
    try {
      const searchResults = await searchPlaces(place);
      if (searchResults.length > 0) {
        // 最初の結果を使用
        locations.push(searchResults[0]);
      }
      // API制限を考慮して少し待機
      await new Promise(resolve => setTimeout(resolve, 100));
    } catch (error) {
      console.error(`Error searching for place: ${place}`, error);
    }
  }

  return locations;
} 